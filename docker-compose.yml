services:
  api_dev_mysql:
    image: mysql:9.3.0
    container_name: api_dev_mysql
    environment:
      MYSQL_ROOT_PASSWORD: tent
    volumes:
      - ./docker_volumes/mysql_data:/var/lib/mysql

  base: &base
    image: darthjee/dev_tent
    volumes:
      - ./docker_volumes/vendor:/home/app/app/vendor
      - ./docker_volumes/configuration:/home/app/app/source/configuration/
      - ./source:/home/app/app
      - ./dev/frontend/dist/:/home/app/app/source/static/

  base_build:
    <<: *base
    container_name: tent_build
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.dev_tent
    command: echo done

  ###################
  # Services

  tent_tests:
    depends_on: [base_build, tent_httpbin, api_dev]
    container_name: tent_tests
    <<: *base
    environment:
      - PHP_ENV=test
      - TEST_SERVER_DOMAIN=tent_app
    command: /bin/bash
    links:
      - tent_app:tent_app
      - tent_httpbin:httpbin
      - api_dev:api_dev

  tent_app:
    depends_on: [base_build, tent_httpbin, api_dev, frontend_dev]
    container_name: tent_app
    <<: *base
    ports:
      - 127.0.0.1:8080:80
    environment:
      - PHP_ENV=development
    command: apache2-foreground
    links:
      - tent_httpbin:httpbin
      - api_dev:api
      - frontend_dev:frontend

  api_dev:
    <<: *base
    depends_on: [base_build, api_dev_mysql, api_dev_phpmyadmin]
    container_name: api_dev
    volumes:
      - ./docker_volumes/vendor:/home/app/app/vendor
      - ./dev/api:/home/app/app
    ports:
      - 127.0.0.1:8040:80
    env_file: .env
    links:
      - api_dev_mysql:mysql
    command: apache2-foreground

  frontend_dev:
    container_name: frontend_dev
    image: darthjee/node:0.2.1
    command: npm run server
    volumes:
      - ./dev/frontend:/home/node/app
      - ./docker_volumes/node_modules:/home/node/app/node_modules
    ports:
      - 127.0.0.1:8030:8080
  
  api_dev_phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: api_dev_phpmyadmin
    depends_on: [api_dev_mysql]
    links:
      - api_dev_mysql:mysql
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      MYSQL_USER: root
      MYSQL_ROOT_PASSWORD: api_dev
      MYSQL_PASSWORD: api_dev
    ports:
      - 127.0.0.1:3050:80

  tent_httpbin:
    image: kennethreitz/httpbin
    container_name: tent_httpbin
    ports:
      - 127.0.0.1:3060:80
